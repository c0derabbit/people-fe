import { useState } from 'react'
import { useRouter } from 'next/router'
import { NextPageContext } from 'next'

import { Field } from '../../styled'
import { apiBase } from '../../config'

export default function AddConnection({ data }) {
  const { query: { id } } = useRouter()

  const [error, setError] = useState<string | null>(null)
  const [success, setSuccess] = useState<string | null>(null)

  async function sendForm(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault()

    const { elements } = e.target as any
    const { to: { value: to }, type: { value: type } } = elements

    const body = { from: id, to, type }

    try {
      const res = await fetch(
        `${apiBase}/relationships/`,
        {
          method: 'POST',
          body: JSON.stringify(body),
          headers: { 'Content-Type': 'application/json' },
        }
      )
      if (res.ok) {
        setError(null)
        setSuccess(`Person ${id ? 'updated' : 'added'} successfully. Yay! ðŸŽ‰`)
      } else {
        setSuccess(null)
        throw res.statusText
      }
    } catch (error) {
      setSuccess(null)
      setError(`Something went wrong: ${error} ðŸ™Š`)
    }
  }


  const {
    props: { name },
  } = data

  return (
    <>
      <h2>Update {name}â€™s connections</h2>
      <Field />
    </>
  )
}

export async function getServerSideProps(context: NextPageContext) {
  const res = await fetch(`${apiBase}/people/${context.query.id}`)
  const data = await res.json()

  return { props: { data } }
}
